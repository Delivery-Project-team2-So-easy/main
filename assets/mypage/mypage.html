<!DOCTYPE html>
<html lang="en">
  <head>
    <base href="/" />
    <title>마이페이지</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* 스타일을 추가할 수 있습니다 */
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
      }
      header {
        background-color: #4caf50;
        color: #fff;
        text-align: center;
        padding: 1rem;
      }
      main {
        padding: 2rem;
      }
      .profile {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .profile img {
        width: 100px;
        border-radius: 50%;
      }

      .review {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 20px;
      }
      .review h3 {
        margin-bottom: 10px;
      }
      .review img {
        width: 80px;
        height: 80px; /* 높이를 추가 */
        object-fit: cover; /* 이미지 비율 유지하면서 지정한 크기에 맞추기 */
        border-radius: 50%;
      }
      .button-container {
        display: flex;
        justify-content: space-between;
      }
      .edit-button,
      .delete-button {
        padding: 5px 10px;
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      /* 모달창 */
      .modal-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
        display: flex;
        flex-direction: column; /* 요소들을 수직 방향으로 배치 */
        align-items: center; /* 가운데 정렬 */
      }
    </style>
  </head>
  <body>
    <header>
      <h1>마이페이지</h1>
    </header>
    <main>
      <div class="profile">
        <img
          src="https://i.namu.wiki/i/Ln7MiLrZm65kiItiQWdvJQpIaRJ5NZpvg9XZ08hFBTai0imKv6UaRRFCYUefmKOP8rdCwdBiwOm_aFTYo6Ib7A.webp"
          alt="https://i.namu.wiki/i/Ln7MiLrZm65kiItiQWdvJQpIaRJ5NZpvg9XZ08hFBTai0imKv6UaRRFCYUefmKOP8rdCwdBiwOm_aFTYo6Ib7A.webp"
        />
        <div>
          <h2>사용자 이름</h2>
          <p>이메일</p>
          <p>소비자 혹은 판매자</p>
          <p>address</p>
          <!-- 사용자 정보 및 프로필 사진 표시 등 추가 정보를 넣을 수 있습니다 -->
        </div>
      </div>
      <div class="review-container">
        <div class="review">
          <h3>리뷰 1</h3>
          <p>제품 A는 좋았어요! 가격 대비 품질이 좋습니다.</p>
          <div class="button-container">
            <button class="edit-button">수정</button>
            <button class="delete-button">삭제</button>
          </div>
        </div>
      </div>
      <!-- 수정 모달창 -->
      <div class="modal-container" id="editModalContainer">
        <div class="modal-content">
          <h3>리뷰 수정</h3>
          <textarea type="text" id="reviewInput" placeholder="리뷰" rows="4"></textarea>
          <input type="number" id="ratingInput" placeholder="점수" min="0" max="100" />
          <button id="saveBtn">저장</button>
          <button id="cancelBtn">취소</button>
        </div>
      </div>
      <!-- 삭제 모달창 -->
      <div class="modal-container" id="deleteModalContainer">
        <div class="modal-content">
          <h3>정말로 삭제하시겠습니까?</h3>
          <button id="checkBtn">삭제</button>
          <button id="deleteCancelBtn">취소</button>
        </div>
      </div>
      <!-- 기타 마이페이지 내용을 넣을 수 있습니다 -->
    </main>
    <script>
      // 데이터 렌더링
      window.addEventListener('DOMContentLoaded', () => {
        // 내 프로필 렌더링
        fetch('/userDetails', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.errorMessage) {
              alert(data.errorMessage);
            }

            const profile = document.querySelector('.profile');
            const myProfile = data.data;
            console.log(myProfile);
            if (myProfile.profileImg == null) {
              myProfile.profileImg = `https://i.namu.wiki/i/Ln7MiLrZm65kiItiQWdvJQpIaRJ5NZpvg9XZ08hFBTai0imKv6UaRRFCYUefmKOP8rdCwdBiwOm_aFTYo6Ib7A.webp`;
            }
            if (myProfile.is_seller) {
              myProfile.is_seller = '판매자';
            } else {
              myProfile.is_seller = '소비자';
            }
            let temp_html = `
          <img
            src="${myProfile.profileImg}"
          />
          <div>
          <h2>이름 : ${myProfile.name}</h2>
          <p>이메일 : ${myProfile.email}</p>
          <p>가입 유형 : ${myProfile.is_seller}</p>
          <p>주소 : ${myProfile.address}</p>
          <p>내 포인트 : ${myProfile.point}</p>
        </div>
        `;
            profile.innerHTML = temp_html;
          });
        // 내 리뷰 렌더링
        fetch('/myReviews', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            const reviewContainer = document.querySelector('.review-container');
            console.log(data);
            const myReviews = data.reviews;
            let temp = '';
            myReviews.map((review) => {
              let temp_html = `
              <div class="review" id="${review.id}">
                <img src="${review.Store.store_img}"/>
                <h3 id=${review.store_id}>${review.Store.store_name}</h3>
                <p>내 리뷰 : ${review.review}</p>
                <p>${review.rating} 점 </p>
                
                <div class="button-container">
                  <button class="edit-button">수정</button>
                  <button class="delete-button">삭제</button>
                </div>
              </div>
            `;
              temp = temp + temp_html;
            });
            reviewContainer.innerHTML = temp;
          });
      });
      const reviewContainer = document.querySelector('.review-container');
      reviewContainer.addEventListener('click', (e) => {
        const storeId = e.target.parentElement.parentElement.querySelector('h3').id;
        const reviewId = e.target.parentElement.parentElement.id;

        if (e.target.className == 'edit-button') {
          // 수정 버튼 누를 시
          const editModalContainer = document.getElementById('editModalContainer');
          const saveBtn = document.getElementById('saveBtn');
          const cancelBtn = document.getElementById('cancelBtn');
          const reviewInput = document.getElementById('reviewInput');
          const ratingInput = document.getElementById('ratingInput');

          editModalContainer.style.display = 'flex';

          saveBtn.addEventListener('click', () => {
            // 수정-확인
            // 수정 api
            fetch(`/store/${storeId}/review/${reviewId}`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                review: reviewInput.value,
                rating: ratingInput.value,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.errorMessage) {
                  alert(data.errorMessage);
                }
                alert(data.message);
                window.location.reload();
              });
          });
          cancelBtn.addEventListener('click', () => {
            // 수정-취소
            editModalContainer.style.display = 'none';
          });
        }
        if (e.target.className == 'delete-button') {
          // 삭제 버튼 누를 시
          const deleteModalContainer = document.getElementById('deleteModalContainer');
          const checkBtn = document.getElementById('checkBtn');
          const deleteCancelBtn = document.getElementById('deleteCancelBtn');

          deleteModalContainer.style.display = 'flex';
          checkBtn.addEventListener('click', () => {
            // 삭제 - 확인
            fetch(`/store/${storeId}/review/${reviewId}`, {
              method: 'DELETE',
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.errorMessage) {
                  alert(data.errorMessage);
                }
                alert(data.message);
                window.location.reload();
              });
          });
          deleteCancelBtn.addEventListener('click', () => {
            // 삭제-취소
            deleteModalContainer.style.display = 'none';
          });
        }
      });
    </script>
  </body>
</html>
