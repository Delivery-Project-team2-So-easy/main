<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      src="https://code.jquery.com/jquery-3.5.1.js"
      integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
    <!-- Font Awesome CSS -->
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <link href="./mystyle.css" rel="stylesheet" />
  </head>
  <body>
    <button type="button" id="orderButton">주문하기</button>
    <button type="button" id="deliveredButton">배달완료</button>
    <button type="button" id="refundButton">배달취소하기</button>
    <button type="button" id="refundComplete">주문취소승인</button>
    <button type="button" id="refundRefuse">주문취소거절</button>
  </body>
  <script>
    const socket = io.connect('/');
    $(document).ready(() => {});
    const button = document.querySelector('#orderButton');
    const button2 = document.querySelector('#deliveredButton');
    const button3 = document.querySelector('#refundButton');
    const button4 = document.querySelector('#refundComplete');
    const button5 = document.querySelector('#refundRefuse');

    button.addEventListener('click', order);
    button2.addEventListener('click', delivered);
    button3.addEventListener('click', refundRequest);
    button4.addEventListener('click', refundComplete);
    button5.addEventListener('click', refundRefuse);
    async function order(event) {
      event.preventDefault();
      let ownerId = 0;
      //5번 가게에 대한 사장 id를 찾기 위함
      await $.ajax({
        type: 'GET',
        url: '/store/5',
        success: (result) => {
          const { user_id } = result.data;
          ownerId = user_id;
        },
        error: (error) => {
          alert(error.responseJSON.errorMessage);
        },
      });
      let header = {};
      const body = { price: 10000, quantity: 2 };
      await $.ajax({
        type: 'POST',
        url: '/order/store/5/menu/4',
        data: JSON.stringify(body),
        contentType: 'application/json',
        success: (result) => {
          const { message } = result;
          const { address, totalPrice } = result.data;
          header = { address, totalPrice, userId: ownerId };
          alert(message);
        },
        error: (error) => {
          alert(error.responseJSON.errorMessage);
        },
      });

      socket.emit('ORDER', header);
    }

    socket.on('STORE_OWNER', (result) => {
      const { ownerId, address, totalPrice, date } = result.data;
      makeOrderToOwner(address, totalPrice, date, ownerId);
    });
    function makeOrderToOwner(customerAddress, orderTotalPrice, date, ownerId) {
      //여기서 링크는 배달 완료를 누를 수 있는 주문 페이지로 렌더링 시킨다.
      const messageHtml = `주문이 들어왔습니다! <br /> 주소 : ${customerAddress}, 주문 가격 : ${orderTotalPrice}입니다! <br />
      <a href="/mypage.html?${ownerId}" class="alert-link">주문 관리 페이지로 이동하기</a><br /> <small>(${date})</small>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
  </button>`;
      const alt = $('#ownerAlert');
      if (alt.length) {
        alt.html(messageHtml);
      } else {
        const htmlTemp = `<div class="alert alert-sparta alert-dismissible show fade" role="alert" id="ownerAlert">${messageHtml}</div>`;
        $('body').append(htmlTemp);
      }
    }
    //------------------------------------//
    async function delivered(event) {
      event.preventDefault();
      //71~79
      let header = {};
      await $.ajax({
        type: 'GET',
        url: '/order/74',
        success: (result) => {
          const { message } = result;
          const { userId } = result.data;
          header.userId = userId;
          alert(message);
        },
        error: (error) => {
          alert(error.responseJSON.errorMessage);
        },
      });

      socket.emit('DELIVERED', header);
    }
    socket.on('CUSTOMER', (result) => {
      const { date } = result.data;
      deliveredCompleteToCustomer(date);
    });

    function deliveredCompleteToCustomer(date) {
      const messageHtml = `배달이 완료 되었어요! 맛있게 드세요! <br /> <small>(${date})</small>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
  </button>`;
      const alt = $('#customerAlert');
      if (alt.length) {
        alt.html(messageHtml);
      } else {
        const htmlTemp = `<div class="alert alert-sparta alert-dismissible show fade" role="alert" id="customerAlert">${messageHtml}</div>`;
        $('body').append(htmlTemp);
      }
    }
    //-------------------------------------------//
    async function refundRequest(event) {
      event.preventDefault();
      let ownerId = 0;
      //5번 가게에 대한 사장 id를 찾기 위함
      await $.ajax({
        type: 'GET',
        url: '/store/5',
        success: (result) => {
          const { user_id } = result.data;
          ownerId = user_id;
        },
        error: (error) => {
          alert(error.responseJSON.errorMessage);
        },
      });
      let header = {};
      await $.ajax({
        type: 'GET',
        url: `/order/74/refundRequest`,
        success: (result) => {
          const { message } = result;
          const { status, orderId } = result.data;
          header = { status, orderId, userId: ownerId };
          alert(message);
        },
        error: (error) => {
          alert(error.responseJSON.errorMessage);
        },
      });

      socket.emit('REFUND_REQUEST', header);
    }

    socket.on('REFUND_REQUEST_OWNER', (result) => {
      const { status, ownerId, orderId, date } = result.data;
      refundRequestToOwner(status, ownerId, orderId, date);
    });
    function refundRequestToOwner(status, ownerId, orderId, date) {
      if (status === 'delivered') {
        const messageHtml = `주문번호 ${orderId}번에 대한 취소 요청이 들어왔어요.  <br />
      <a href="/mypage.html?${ownerId}" class="alert-link">주문 관리 페이지로 이동하기</a><br /> <small>(${date})</small>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
  </button>`;
        const alt = $('#ownerAlert');
        if (alt.length) {
          alt.html(messageHtml);
        } else {
          const htmlTemp = `<div class="alert alert-sparta alert-dismissible show fade" role="alert" id="ownerAlert">${messageHtml}</div>`;
          $('body').append(htmlTemp);
        }
      } else {
        //여기서 링크는 주문 취소 요청을 확인할 수 있는 주문 페이지로 렌더링 시킨다.
        const messageHtml = `주문번호 ${orderId}번 주문이 취소 되었습니다. <br /> 
      <a href="/mypage.html?${ownerId}" class="alert-link">주문 관리 페이지로 이동하기</a><br /> <small>(${date})</small>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
  </button>`;
        const alt = $('#ownerAlert');
        if (alt.length) {
          alt.html(messageHtml);
        } else {
          const htmlTemp = `<div class="alert alert-sparta alert-dismissible show fade" role="alert" id="ownerAlert">${messageHtml}</div>`;
          $('body').append(htmlTemp);
        }
      }
    }
    //-------------------------------------------------------------//
    async function refundComplete(event) {
      event.preventDefault();
      let header = {};
      await $.ajax({
        type: 'GET',
        url: '/order/72/refundComplete',
        success: (result) => {
          const { message } = result;
          const { userId, point } = result.data;
          header = { userId, point };
          alert(message);
        },
        error: (error) => {
          alert(error.responseJSON.errorMessage);
        },
      });

      socket.emit('REFUND_COMPLETE', header);
    }
    socket.on('REFUND_COMPLETE_CUSTOMER', (result) => {
      const { point, date } = result.data;
      refundCompleteToCustomer(point, date);
    });

    function refundCompleteToCustomer(point, date) {
      const messageHtml = `환불 요청이 정상적으로 완료 되었습니다. 불편을 드려 죄송합니다. <br />
       ${point}포인트가 다시 입금 되었습니다. <br /> <small>(${date})</small>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
  </button>`;
      const alt = $('#customerAlert');
      if (alt.length) {
        alt.html(messageHtml);
      } else {
        const htmlTemp = `<div class="alert alert-sparta alert-dismissible show fade" role="alert" id="customerAlert">${messageHtml}</div>`;
        $('body').append(htmlTemp);
      }
    }
    //------------------------------------------//
    async function refundRefuse(event) {
      event.preventDefault();
      let header = {};
      await $.ajax({
        type: 'GET',
        url: '/order/74/refundRefuse',
        success: (result) => {
          const { message } = result;
          const { userId } = result.data;
          header = { userId };
          alert(message);
        },
        error: (error) => {
          alert(error.responseJSON.errorMessage);
        },
      });

      socket.emit('REFUND_REFUSE', header);
    }
    socket.on('REFUND_REFUSE_CUSTOMER', (result) => {
      const { date } = result.data;
      refundCompleteToCustomer(date);
    });

    function refundCompleteToCustomer(date) {
      const messageHtml = `환불 요청이 거절 되었습니다. 불편을 드려 죄송합니다. <br /> <small>(${date})</small>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
  </button>`;
      const alt = $('#customerAlert');
      if (alt.length) {
        alt.html(messageHtml);
      } else {
        const htmlTemp = `<div class="alert alert-sparta alert-dismissible show fade" role="alert" id="customerAlert">${messageHtml}</div>`;
        $('body').append(htmlTemp);
      }
    }
  </script>
</html>
